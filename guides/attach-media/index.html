<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="en-us" />
  <meta http-equiv="imagetoolbar" content="false" />
  <meta name="MSSmartTagsPreventParsing" content="true" />
  <meta name="description" content="How to attach media from your WebRTC application with SIP.js." />
  <meta name="viewport" content="initial-scale=1" />
  <title>Attach media | SIP.js</title>
  <link rel="alternate" type="application/atom+xml" title="API Changes" href="/changes.atom" />
  <link href='//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round' rel='stylesheet' type='text/css'>
  <link href="/css/reset.css" rel="stylesheet" type="text/css" />
  <link href="/css/960.css" rel="stylesheet" type="text/css" />
  <link href="/css/uv_active4d.css" rel="stylesheet" type="text/css" />
  <link href="/shared/css/documentation.css" media="screen" rel="stylesheet" type="text/css" />
    
  <link href="/shared/css/pygments.css" media="screen" rel="stylesheet" type="text/css" />
  
  <script src="/shared/js/jquery.js" type="text/javascript"></script>
  <script src="/shared/js/documentation.js" type="text/javascript"></script>
  <link rel="shortcut icon" type="image/x-icon" href="/shared/img/favicon-7.ico"/>
</head>


<body class="guides">
  <div id="dev"></div>
<header id="siteHeader">
  <div class="wrapper">
    <nav id="mainNav">
      <a id="logo-link" href="/"><img id="logo" src="/shared/img/logo.png" alt="sip.js"></a>
      <ul id="full-nav" class="horizontal mobile-hide">
        <li><a href="https://github.com/onsip/SIP.js/releases">Download</a></li>
        <li><a id="api-nav" href="https://github.com/onsip/SIP.js/blob/master/docs/README.md">API</a></li>
        <li><a href="/guides/">Guides</a></li>
        <li><a href="https://github.com/onsip/sip.js" target="_blank">Github</a></li>
        <li><a href="/aboutus/" class="nav-aboutus">About Us</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/sip_js" target="_blank">Support</a></li>
        <li><a href="/faq/">FAQ</a></li>
      </ul>
    </nav>
  </div>
</header>


  <article id="main" class="wrapper group">
    <header id="sectionHeader">
      <h1><a href="/guides/">Guides</a></h1>
    </header>
    <div id="content">
      
<h1 id="attach-media">Attach Media</h1>

<p>This guide uses the full <a href="https://github.com/onsip/SIP.js/blob/master/docs/api/sip.js.md">SIP.js API</a>. The <a href="./simple">Simple User</a> is intended to help get beginners up and running quickly. This guide is adopted from the <a href="https://github.com/onsip/SIP.js/blob/master/docs/api.md">SIP.js Github API documentation</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>See the <a href="./user-agent">User Agent</a> guide on how to create a user agent. This guide requires a registered user agent.</p>

<p>See the <a href="./make-call">Make a Call</a> guide on how to make a call.</p>

<p>See the <a href="./receive-call">Receive a Call</a> guide on how to receive a call.</p>

<p>SIP.js tries to leave the majority of handling media to the user application. This guide assumes that your application is using the built in Session Description Handler in a standard Web Browser with full WebRTC support.</p>

<h2 id="session-state-change">Session State Change</h2>

<p>When SIP.js sets up a session, the session goes through a life cycle. When the session is <code>Established</code> you may want to play media for your user. To do this you will need to get a handle on the session state. An event listener can be added to the <code>stateChange</code> event emitter. The listener can be added to an <code>Inviter</code> before calling the <code>invite()</code> function or to an <code>Invitation</code> before calling the <code>accept()</code> or <code>reject()</code> function. These functions are purposely split from the constructor to give your application appropriate time to add listeners.</p>

<pre><code class="language-javascript"><span class="kr">const</span> <span class="nx">inviter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Inviter</span><span class="p">(</span><span class="nx">userAgent</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="nx">inviter</span><span class="p">.</span><span class="nx">statChange</span><span class="p">.</span><span class="nx">addListener</span><span class="p">((</span><span class="nx">state</span><span class="o">:</span> <span class="nx">SessionState</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Session state changed to </span><span class="si">${</span><span class="nx">state</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Initial</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Establishing</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Established</span><span class="o">:</span>
      <span class="nx">setupRemoteMedia</span><span class="p">(</span><span class="nx">inviter</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Terminating</span><span class="o">:</span>
      <span class="c1">// fall through</span>
    <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Terminated</span><span class="o">:</span>
      <span class="nx">cleanupMedia</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Unknown session state."</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">inviter</span><span class="p">.</span><span class="nx">invite</span><span class="p">();</span></code></pre>

<pre><code class="language-javascript"><span class="kd">function</span> <span class="nx">onInvite</span><span class="p">(</span><span class="nx">invitation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">invitation</span><span class="p">.</span><span class="nx">stateChange</span><span class="p">.</span><span class="nx">addListener</span><span class="p">((</span><span class="nx">state</span><span class="o">:</span> <span class="nx">SessionState</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Session state changed to </span><span class="si">${</span><span class="nx">state</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Initial</span><span class="o">:</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Establishing</span><span class="o">:</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Established</span><span class="o">:</span>
        <span class="nx">setupRemoteMedia</span><span class="p">(</span><span class="nx">invitation</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Terminating</span><span class="o">:</span>
        <span class="c1">// fall through</span>
      <span class="k">case</span> <span class="nx">SessionState</span><span class="p">.</span><span class="nx">Terminated</span><span class="o">:</span>
        <span class="nx">cleanupMedia</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Unknown session state."</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">invitation</span><span class="p">.</span><span class="nx">accept</span><span class="p">();</span>
<span class="p">}</span></code></pre>

<h2 id="attaching-media">Attaching Media</h2>

<p>Once you have a handle on the session and the state you can get the Session Description Handler and then get the tracks from the Session Description Handler. There is no common interface for doing this since the Session Description Handler can be swapped out by the userâ€™s application.</p>

<pre><code class="language-javascript"><span class="c1">// Assumes you have a media element on the DOM</span>
<span class="kr">const</span> <span class="nx">mediaElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'mediaElement'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">remoteStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MediaStream</span><span class="p">();</span>
<span class="kd">function</span> <span class="nx">setupRemoteMedia</span><span class="p">(</span><span class="nx">session</span><span class="o">:</span> <span class="nx">Session</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">session</span><span class="p">.</span><span class="nx">sessionDescriptionHandler</span><span class="p">.</span><span class="nx">peerConnection</span><span class="p">.</span><span class="nx">getReceivers</span><span class="p">().</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">receiver</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">track</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">remoteStream</span><span class="p">.</span><span class="nx">addTrack</span><span class="p">(</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">track</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">mediaElement</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="nx">remoteStream</span><span class="p">;</span>
  <span class="nx">mediaElement</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
<span class="p">}</span></code></pre>

<h2 id="cleaning-up-media">Cleaning up Media</h2>

<p>Once the call is complete you may want to clean up the media elements used by the call.</p>

<pre><code class="language-javascript"><span class="c1">// Assumes you have a media element on the DOM</span>
<span class="kd">var</span> <span class="nx">mediaElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'mediaElement'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">cleanupMedia</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">mediaElement</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">mediaElement</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
<span class="p">}</span></code></pre>

    </div>

    <nav id="sideNav">
  <ul>
    <li><a href="/guides/">Overview</a></li>
    <li class="parent">
      <a class="parent" href="/guides/server-configuration/">Server Configuration</a>
      <ul>
        <li><a href="/guides/server-configuration/freeswitch/">FreeSWITCH</a></li>
        <li><a href="/guides/server-configuration/asterisk/">Asterisk</a></li>
        <li><a href="/guides/server-configuration/onsip-network/">OnSIP</a></li>
      </ul>
    </li>
    <li><a href="/guides/simple-user/">Simple User</a></li>
    <li><a href="/guides/user-agent/">User Agent</a></li>
    <li><a href="/guides/make-call/">Make a Call</a></li>
    <li><a href="/guides/receive-call/">Receive a Call</a></li>
    <li><a href="/guides/end-call/">End a Call</a></li>
    <li><a href="/guides/attach-media/">Attach Media</a></li>
    <li><a href="/guides/send-dtmf/">Send DTMF</a></li>
    <li><a href="/guides/send-message/">Send Message</a></li>
    <li><a href="/guides/transfer/">Make a Transfer</a></li>
    <li><a class="last" href="/guides/full-demo-app/">Application Demo</a></li>
  </ul>
</nav>


  </article>

  <footer class="light-gray-bg">
  <div class="wrapper">
    <div id="onsip-stamp">
      <span id="made-by-prefix">made by</span>
      <a href="http://developer.onsip.com" id="onsip"></a>
    </div>
    <nav class="left">
      <ul class="horizontal">
        <li><a href="https://groups.google.com/forum/#!forum/sip_js" target="_blank">Mailing List</a></li>
        <li><a href="https://github.com/onsip/sip.js/issues" target="_blank">Report Issues</a></li>
        <li><a href="/license/">License</a></li>
      </ul>
    </nav>
    <nav class="right">
      <ul class="horizontal">
        <li><a href="https://travis-ci.org/onsip/SIP.js"><img src="https://travis-ci.org/onsip/SIP.js.png?branch=master"/></a></li>
        <li><a href="http://onsip.com/blog" target="_blank">Blog</a></li>
        <li><a href="/aboutus/">About</a></li>
        <li><a href="/faq/">FAQ</a></li>
      </ul>
    </nav>
    <div class="clearfix"></div>
  </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1008379-16', 'sipjs.com');
  ga('send', 'pageview');
</script>
<script>
  // Remove all 'no-js-hide' classes because Javascript is working
  $(function () {
      $('.no-js-hide').each(function (i, e) {
          $(e).removeClass('no-js-hide');
      });
      $('.no-js-block').each(function (i, e) {
          $(e).removeClass('no-js-block');
      });
  });
</script>


</body>
</html>
